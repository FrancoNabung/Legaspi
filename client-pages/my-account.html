<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Account - Legaspi Dental Clinic</title>
    <link rel="stylesheet" href="/client-pages/my-account.css">
    <link rel="icon" type="image/x-icon" href="/images/teeth.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body>
    <!--Dark Overlay-->
    <div class="dark-modal-overlay" id="dark-modal-overlay"></div>
    <!--Edit Password-->
    <div class="edit-password-content-container" id="edit-password">
            <div class="edit-password-content">
                <div class="password-textbox">
                    <p class="label">Current Password</p>
                    <input type="password" placeholder="Password" id="currentPass">
                    <p class="label">New Password</p>
                    <input type="password" placeholder="Password" id="newPass"> 
                    <p class="label">Confirm New Password</p>
                    <input type="password" placeholder="Password" id="confirmPass"> 
                </div>
                <div class="edit-password-btn-container info-flex-container-space-between">
                    <button class="edit-btn" onclick="closeModal()">Cancel</button>
                    <button class="edit-btn">Save Changes</button>
                </div>
            </div>
    </div>
    <!--Logout-->
    <div class="logout-content-container" id="logout-content">
            <div class="logout-content">
                <div>
                    <p class="label">Are you sure you want to logout?</p>
                </div>
                <div class="logout-btn-container info-flex-container-space-between">
                    <button class="edit-btn" onclick="closeModal()">No</button>
                    <a href="/index.html"><button class="edit-btn">Yes</button></a>
                </div>
            </div>
    </div>
    <!--Reschedule-->
    <div class="reschedule-container" id="reschedule">
        <div class="reschedule">
            <div>
                <p class="label">Are you sure you want to reschedule your appointment?</p>
            </div>
            <div class="reschedule-btn-container info-flex-container-space-between">
                <button class="edit-btn" onclick="closeModal()">No</button>
                <button class="edit-btn">Yes</button>
            </div>
        </div>
    </div> 
    <!--Cancel Appointment-->
    <div class="cancel-appointment-container" id="cancel-appointment">
        <div class="cancel-appointment">
            <div>
                <p class="label">Are you sure you want to cancel your appointment?</p>
            </div>
            <div class="cancel-appointment-btn-container info-flex-container-space-between">
                <button class="edit-btn" onclick="closeModal()">No</button>
                <Button class="edit-btn" onclick="cancelLastAppointment()" id="cancel">Yes</Button>
            </div>
        </div>
    </div>
    <!--Book Appointment-->
    <div class="book-appointment-container" id="book-appointment">
        <div class="book-appointment">
            <div>
                <p class="label">Do you want to book an appointment?</p>
            </div>
            <div class="info-flex-container-space-between">
                <button class="edit-btn" onclick="closeModal()">No</button>
                <a href="book-appointment.html"><button class="edit-btn">Yes</button></a>
            </div>
        </div>
    </div>
    <!--Header-->
    <header>
        <!--Navigation Bar-->
        <div class="col-lg-12 col-sm-12 col-md-12 navigation-bar">
            <img src="/images/legaspi_dental_clinic_logo.jpg" class="legaspi_logo fade-in" alt="legaspi">
            <nav class="navigation-links">
                
            </nav>
        </div>
        <!--Hamburger Menu-->
        <div class="hamburger-container">
            <div class="hamburger">
            <div class="bar"></div>
        </div>
        
    </header>
    <!--Mobile Navigation-->
    <div>
        <nav class="mobile-nav">
            <a href="/client-pages/index-w-acc.html" class="nav-link">HOME</a>
            <a href="#" class="nav-link" onclick="mydetailsOpen()">MY DETAILS</a>
            <a href="#" class="nav-link" onclick="appointmentOpen()">APPOINTMENTS</a>
            <a href="#" class="nav-link" onclick="historyOpen()">HISTORY</a>
            <a href="book-appointment.html" class="nav-link mobile-nav2" style="color: white;">BOOK APPOINTMENT</a>
        </nav>
    </div>
    <!--Side Navigation-->
    <div>
        <div class="my-account-nav">
            <div class="my-account-small-nav">
                <a href="/client-pages/index-w-acc.html"><p>Home</p></a>
                <p class="my-account-small-nav-slash"> / </p>
                <p class="my-account-small-nav-current">My Account</p>
            </div>
                <p>My Account</p>
            <button class="btn-account" id="btn-my-details" onclick="mydetailsOpen()">My Details</button>
            <button class="btn-appointment"id="btn-appointment" onclick="appointmentOpen()">Appointments</button>
            <button class="btn-history"id="btn-third-div" onclick="historyOpen()">History</button>
            <a class="a-flex" onclick="bookappointment()"><button class="btn-book-now">Book now!</button></a>
            
        </div>
    </div>
    <!--Account Modal-->
    <div class="my-account-modal-container">
        <div class="my-account-modal">
            <!--My Details Content-->
            <div class="my-details-content" id="my-details">
                <!--Title-->
                <div>
                    <p class="title">My Details</p>
                    <p class="subtext">Personal Information</p>
                    <div class="divider"></div>
                </div>
                <div class="modal-container">
                    <!--Change Account Information here-->
                    <!--ID-->
                    <div class="info-flex-container">
                        <div>
                            <p class="label">ID</p>
                            <div class="info-container-percent">
                                <div class="info">
                                    <!--Lagay mo info dito-->
                                    <p id="userID">Placeholder</p>
                                    <!---------------------->
                                </div>
                            </div>
                        </div>
                    </div>
                    <!--First Name and Last Name-->
                    <div class="info-flex-container">
                        <div>
                            <p class="label">First Name</p>
                            <div class="info-container">
                                <div class="info">
                                    <!--Lagay mo info dito-->
                                    <p id="firstName">Placeholder</p>
                                    <!---------------------->
                                </div>
                            </div>
                        </div>
                        <div>
                            <p class="label">Last Name</p> 
                            <div class="info-container">
                                <div class="info">
                                    <!--Lagay mo info dito-->
                                    <p id="lastName">Placeholder</p>
                                    <!---------------------->
                                </div>
                            </div>
                        </div>
                    </div>
                    <!--Birth Date, Age and Sex-->
                    <div class="info-flex-container">
                        <!--Birth Date-->
                        <div>
                            <p class="label">Birth Date</p>
                            <div class="info-container-percent">
                                <div class="info">
                                    <!--Lagay mo info dito-->
                                    <p id="birthDate">02/13/2006</p>
                                    <!---------------------->
                                </div>
                            </div>
                        </div>
                        <!--Age-->
                        <div>
                            <p class="label">Age</p>
                            <div class="info-container-percent">
                                <div class="info">
                                    <!--Lagay mo info dito-->
                                    <p id="age">18</p>
                                    <!---------------------->
                                </div>
                            </div>
                        </div>
                        <!--Sex-->
                        <div>
                        <p class="label">Sex</p>
                        <div class="info-container-percent">
                            <div class="info">
                                <!--Lagay mo info dito-->
                                <p id="sex">Male</p>
                                <!---------------------->
                            </div>
                        </div>
                        </div>
                    </div>
                    <!--Email-->
                    <div>
                        <div>
                            <p class="label">E-mail Address</p>
                            <div class="email-container">
                                <div class="info-container-email">
                                    <div class="info">
                                        <!--Lagay mo info dito-->
                                        <p id="email">Exampleeeeeeeeeeee@gmail.com</p>
                                        <!---------------------->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!--Contact No.-->
                    <div>
                        <div>
                            <p class="label">Contact No.</p>
                            <div class="info-container">
                                <div class="info">
                                    <!--Lagay mo info dito-->
                                    <p id="contactNo">+639696210259</p>
                                    <!---------------------->
                                </div>
                            </div>
                        </div>
                    </div>
                        <!--Change Password-->
                        <div>
                            <!--Title-->
                            <div>
                                <p class="subtext">Change Password</p>
                                <div class="divider"></div>
                            </div>
                            <div>
                                <p class="label">Password</p>
                                <div class="info-container">
                                    <div class="info">
                                        <!--Lagay mo info dito-->
                                        <p id="password">*********</p>
                                        <!---------------------->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!--Edit Password Button-->
                        <div class="edit-btn-container" >
                            <button class="edit-btn" onclick="editpass()">Edit</button>
                        </div>
                        <!--Logout-->
                        <div class="logout-container">
                            <p class="subtext">LOGOUT</p>
                            <div class="divider"></div>
                            <!--Logout Button-->
                            <button class="logout-btn" onclick="logout()">LOGOUT</button>
                        </div>
                    <!---------------------------------->
                    </div>
            </div>
            <!--Appointment Content-->
            <div class="appointment-content" id="appointment">
                <!--Title-->
                <div>
                    <p class="title">Appointments</p>
                    <div class="info-flex-container-space-between">
                        <div>
                            <p class="subtext">Active Appointments</p>
                        </div>
                        <div class="search-container">
                            <div class="search-icon-flex">
                                <input class="search-textbox"type="search" placeholder="Search...">
                                <div class="search-icon-container">
                                <i class="fa fa-search search-icon"></i>
                            </div>
                            </div>
                        </div>
                    </div>
                    <div class="divider"></div>
                </div>
                <div class="modal-container">
                    <!--Appointment-modal-->
                    <div class="appointment-modal">
                        <!--Edit mo ung service info here-->
                        <div class="info-flex-container">
                            <p class="label">Service</p>
                            <div class="info-container-underline">
                                <div>
                                    <!--Lagay mo info dito-->
                                    <p id="services">PLACEHOLDER</p>
                                    <!---------------------->
                                </div>
                            </div>
                        </div>
                        <!--------------------------------->
                        <!--Edit mo account info here-->
                        <div class="info-flex-container">
                            <!--ID-->
                            <div>
                                <p class="label">ID</p>
                                <div class="info-container-percent">
                                    <div class="info">
                                        <!--Lagay mo info dito-->
                                        <p>01</p>
                                        <!---------------------->
                                    </div>
                                </div>
                            </div>
                            <!--First Name-->
                            <div>
                                <p class="appointment-label">First Name</p>
                                <div class="info-container">
                                    <div class="info">
                                        <!--Lagay mo info dito-->
                                        <p id="firstsName">PLACEHOLDER</p>
                                        <!---------------------->
                                    </div>
                                </div>
                            </div>
                            <!--Last Name-->
                            <div>
                                <p class="appointment-label">Last Name</p> 
                                <div class="info-container">
                                    <div class="info">
                                        <!--Lagay mo info dito-->
                                        <p id="lastsName">PLACEHOLDER</p>
                                        <!---------------------->
                                    </div>
                                </div>
                            </div>
                            <!--Age-->
                            <div>
                                <p class="label">Age</p>
                                <div class="info-container-percent">
                                    <div class="info">
                                        <!--Lagay mo info dito-->
                                        <p id="age">00</p>
                                        <!---------------------->
                                    </div>
                                </div>
                            </div>
                            <!--Sex-->
                            <div>
                                <p class="label" id="sex">Sex</p>
                                <div class="info-container-percent">
                                    <div class="info">
                                        <!--Lagay mo info dito-->
                                        <p id="sex">Male</p>
                                        <!---------------------->
                                    </div>
                                </div>
                            </div>
                            <!--date-->
                            <div>
                                <p class="label">Date</p>
                                <div class="info-container-percent">
                                    <div class="info">
                                        <!--Lagay mo info dito-->
                                        <p id="date">00/00/0000</p>
                                        <!---------------------->
                                    </div>
                                </div>
                            </div>
                            <!--Time-->
                            <div>
                                <p class="label">Time</p>
                                <div class="info-container">
                                    <div class="info">
                                        <!--Lagay mo info dito-->
                                        <p id="time">00:00am - 00:00am</p>
                                        <!---------------------->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!----------------------------->
                        <!--Resched and cancel Buttons-->
                        <div class="appointment-btn-container">
                        
                            <button class="appointment-btn" onclick="cancelappointment()">
                                cancel
                            </button>
                        </div>
                    </div>
                </div>
                <!--Book Appointment Button-->
            
            </div>
            <!--History-->
            <div class="history-content" id="third-div">
                <!--Title-->
                <div>
                    <p class="title">History</p>
                    <div class="info-flex-container-space-between">
                        <div>
                            <p class="subtext">Previous Appointments</p>
                        </div>
                        <div class="search-container">
                            <div class="search-icon-flex">
                                <input class="search-textbox"type="search" placeholder="Search...">
                                <div class="search-icon-container">
                                <i class="fa fa-search search-icon"></i>
                            </div>
                            </div>
                        </div>
                        
                    </div>
                    <div class="divider"></div>
                </div> 
                <div class="modal-container">
                <!--append ka appointment modal dito-->
                <!--Paste Previews appointment info here-->
                    <div class="appointment-modal">
                        <!--Paste Previews Service here-->
                        <div class="info-flex-container">
                            <p class="label">Service</p>
                            <div class="info-container-underline">
                                <div>
                                    <!--Lagay mo info dito-->
                                    <p>Root Canal Treatment</p>
                                    <!---------------------->
                                </div>
                            </div>
                        </div>
                        <!--------------------------------->
                        <!--Paste Previews appointment info here-->
                        <div class="info-flex-container">
                            <!--ID-->
                            <div>
                                <p class="label">ID</p>
                                <div class="info-container-percent">
                                    <div class="info">
                                        <!--Lagay mo info dito-->
                                        <p>03</p>
                                        <!---------------------->
                                    </div>
                                </div>
                            </div>
                            <!--First Name-->
                            <div>
                                <p class="appointment-label">First Name</p>
                                <div class="info-container">
                                    <div class="info">
                                        <!--Lagay mo info dito-->
                                        <p>PLACEHOLDER</p>
                                        <!---------------------->
                                    </div>
                                </div>
                            </div>
                            <!--Last Name-->
                            <div>
                                <p class="appointment-label">Last Name</p> 
                                <div class="info-container">
                                    <div class="info">
                                        <!--Lagay mo info dito-->
                                        <p>PLACEHOLDER</p>
                                        <!---------------------->
                                    </div>
                                </div>
                            </div>
                            <!--Age-->
                            <div>
                                <p class="label">Age</p>
                                <div class="info-container-percent">
                                    <div class="info">
                                        <!--Lagay mo info dito-->
                                        <p>00</p>
                                        <!---------------------->
                                    </div>
                                </div>
                            </div>
                            <!--Sex-->
                            <div>
                                <p class="label">Sex</p>
                                <div class="info-container-percent">
                                    <div class="info">
                                        <!--Lagay mo info dito-->
                                        <p>SEX</p>
                                        <!---------------------->
                                    </div>
                                </div>
                            </div>
                            <!--date-->
                            <div>
                                <p class="label">Date</p>
                                <div class="info-container-percent">
                                    <div class="info">
                                        <!--Lagay mo info dito-->
                                        <p>00/00/00</p>
                                        <!---------------------->
                                    </div>
                                </div>
                            </div>
                            <!--Time-->
                            <div>
                                <p class="label">Time</p>
                                <div class="info-container">
                                    <div class="info">
                                        <!--Lagay mo info dito-->
                                        <p>00:00 - 00:00</p>
                                        <!---------------------->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!----------------------------->
                    </div>
                </div>
                <!---------------------------------------->
            </div>
        </div>
    </div>
    <!--Javascript Files-->



   <script>
       document.addEventListener('DOMContentLoaded', async function () {
        try {
            const userDataResponse = await fetch('/user', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                },
            });

            if (userDataResponse.ok) {
                const userData = await userDataResponse.json();
                populateUserData(userData);
            } else {
                const result = await userDataResponse.json();
                alert(result.message);
            }
        } catch (error) {
            console.error(error);
        }
    });

    async function changePassword() {
        try {
            const currentPass = document.getElementById('currentPass').value;
            const newPass = document.getElementById('newPass').value;
            const confirmPass = document.getElementById('confirmPass').value;

            if (newPass !== confirmPass) {
                alert('New password and confirm password do not match');
                return;
            }

            const validatePasswordResponse = await fetch('/validate-password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ currentPass }),
            });

            if (!validatePasswordResponse.ok) {
                const result = await validatePasswordResponse.json();
                alert(result.message);
                return;
            }

            const changePasswordResponse = await fetch('/change-password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ newPass }),
            });

            if (changePasswordResponse.ok) {
                alert('Password changed successfully');
            } else {
                const result = await changePasswordResponse.json();
                alert(result.message);
            }
        } catch (error) {
            console.error(error);
        }
    }

    function populateUserData(userData) {
        document.getElementById('userID').textContent = userData._id;
        document.getElementById('firstName').textContent = userData.firstName;
        document.getElementById('lastName').textContent = userData.lastName;
        document.getElementById('birthDate').textContent = new Date(userData.birthDate).toLocaleDateString(); 
        document.getElementById('sex').textContent = userData.sex;
        document.getElementById('email').textContent = userData.email;
        document.getElementById('contactNo').textContent = userData.contactNo;
        
        const birthDate = new Date(userData.birthDate);
        const currentDate = new Date();
        const age = calculateAge(birthDate, currentDate);
        document.getElementById('age').textContent = age.toString();
    }

    function calculateAge(birthDate, currentDate) {
        const diff = currentDate.getTime() - birthDate.getTime();
        const ageDate = new Date(diff);
        return Math.abs(ageDate.getUTCFullYear() - 1970);
    }

    document.addEventListener('DOMContentLoaded', async function () {
        const appointmentData = await fetchAppointmentData();

        document.getElementById('firstsName').textContent = appointmentData.firstName;
        document.getElementById('lastsName').textContent = appointmentData.lastName;
        document.getElementById('age').textContent = appointmentData.age;
        document.getElementById('sex').textContent = appointmentData.sex;
        document.getElementById('date').textContent = appointmentData.date;
        document.getElementById('time').textContent = appointmentData.time;

        const servicesList = document.getElementById('services');
        servicesList.innerHTML = '';
        appointmentData.services.forEach(service => {
            const listItem = document.createElement('li');
            listItem.textContent = service;
            servicesList.appendChild(listItem);
        });
    });

    async function fetchAppointmentData() {
        try {
            const response = await fetch('http://localhost:3000/api/appointments/latest', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                }
            });

            if (response.ok) {
                return await response.json();
            } else {
                const result = await response.json();
                alert(result.error);
            }
        } catch (error) {
            console.error(error);
        }
    }

    async function logout() {
        try {
            const response = await fetch('/logout', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
            });

            if (response.ok) {
                window.location.href = '/index.html';
            } else {
                console.error('Logout failed:', response.statusText);
            }
        } catch (error) {
            console.error('Error during logout:', error);
        }
    }
    async function cancelLastAppointment() {
    try {
        const response = await fetch('/api/appointments/latest', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            },
        });

        if (response.ok) {
            const latestAppointment = await response.json();
            const confirmation = confirm("Are you sure you want to cancel the last appointment?");
            if (confirmation) {
                const deleteResponse = await fetch(`/api/appointments/${latestAppointment._id}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });

                if (deleteResponse.ok) {
                    const modal = document.querySelector('.appointment-modal');
                    modal.parentNode.removeChild(modal);
                    window.location.href="book-appointment.html";
                    alert('Last appointment canceled successfully');
                } else {
                    const result = await deleteResponse.json();
                    alert(result.error);
                }
            }
        } else {
            const result = await response.json();
            alert(result.error);
        }
    } catch (error) {
        console.error(error);
    }
}


   </script>
    
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="js/bootstrap.bundle.js"></script>
    <script src="/client-pages/my-account.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy" crossorigin="anonymous"></script>
</body>
</html>